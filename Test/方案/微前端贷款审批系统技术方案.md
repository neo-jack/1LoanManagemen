# 微前端贷款审批系统技术方案

## 一、需求分析

### 1.1 角色定义

| 角色   | 权限模块                         | 核心功能                               |
| ------ | -------------------------------- | -------------------------------------- |
| 学生   | 贷款模块、信息通知模块           | 申请贷款、查询申请列表、填写表单       |
| 审核员 | 贷款模块、信息通知模块           | 审核通过、审核驳回、查询待审核列表     |
| 总审核 | 人事模块、贷款模块、信息通知模块 | 最终审批、表单设置、学生管理、人事管理 |

### 1.2 功能模块

```
├── 主应用 H01Front (main-app)
│   ├── 登录认证
│   ├── 权限控制
│   ├── 布局框架
│   └── 信息通知模块 (嵌入常用模块旁边)
│       └── 通知列表/通知详情
│
├── 人事模块 H02Front (hr-app) - 仅总审核
│   ├── 学生管理
│   └── 审核员管理
│
├── 贷款模块 H03Front (loan-app) - 贷款管理
│   ├── 申请列表 (学生)
│   ├── 申请表单 (学生)
│   ├── 审核列表 (审核员/总审核)
│   ├── 审核操作 (审核员/总审核)
│   ├── 表单设置 (总审核)
│   └── [qiankun嵌入] 流程设置 (加载 F04 的 FlowConfig 页面)
│
└── 流程管理平台 F04Front (flow-app) - 流程审核确认
    ├── 流程设置 (被 H03 嵌入，路由 /loan/flow-config)
    └── 流程审核 (独立访问，用于确认审批)
        ├── 代办 - 待审核的流程
        ├── 已办 - 已处理的流程
        └── 已抄送 - 抄送给我的流程
```

## 二、技术架构

### 2.1 微前端方案选型

采用 **混合式微前端** 架构：

- 主体应用通过菜单链接跳转
- F04 流程设置通过 **qiankun** 嵌入 H03
- 统一登录认证，Token 共享（localStorage）
- 各应用可独立开发、测试、部署

### 2.2 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        统一登录认证                             │
│                   (Token 存储 localStorage)                     │
└─────────────────────────────────────────────────────────────────┘
                                │
     ┌──────────────────────────┼──────────────────────────┐
     │                          │                          │
┌──────────┐            ┌──────────┐              ┌──────────────┐
│ H01Front │            │ H02Front │              │   H03Front   │
│  :8000   │   链接     │  :16002  │    链接      │    :16003    │
│  主应用  │ ←────────→ │ 人事应用 │ ←──────────→ │   贷款应用   │
├──────────┤            ├──────────┤              ├──────────────┤
│ 登录认证 │            │ 学生管理 │              │ 申请功能     │
│ 信息通知 │            │ 审核员   │              │ 审核功能     │
│ 导航菜单 │            │ 管理     │              │ 表单设置     │
└──────────┘            └──────────┘              │ [qiankun]    │
                                                  │ 流程设置     │
     ┌────────────────────────────────────────────┴──────────────┐
     │                                                            │
     │                                                            │
┌──────────────┐                                                  │
│   F04Front   │          qiankun 嵌入                            │
│    :16004    │ ─────────────────────────────────────────────────┘
│  流程平台    │
├──────────────┤
│ 流程设置     │ ←── 被 H03 嵌入
│ 流程审核     │
│  - 代办      │
│  - 已办      │
│  - 已抄送    │
└──────────────┘
```

### 2.3 技术栈

| 层级     | 技术选型                                |
| -------- | --------------------------------------- |
| 各应用   | React 18 + Umi Max 4.x + Ant Design 5.x |
| 微前端   | qiankun (F04 嵌入 H03)                  |
| 状态管理 | Umi Model + localStorage (Token 共享)   |
| 样式方案 | Less + CSS Modules                      |
| 认证方式 | JWT Token + localStorage                |
| 构建工具 | Umi 内置 webpack                        |

## 三、项目结构

```
end-project/
├── H01Front/                    # 主应用 (main-app)
│   ├── src/
│   │   ├── components/
│   │   │   ├── Layout/             # 全局布局
│   │   │   └── Navigation/         # 导航菜单 (包含跳转链接)
│   │   ├── pages/
│   │   │   ├── Login/              # 登录页
│   │   │   ├── Dashboard/          # 仪表盘
│   │   │   └── Notice/             # 信息通知模块 (嵌入主应用)
│   │   │       ├── List/           # 通知列表
│   │   │       └── Detail/         # 通知详情
│   │   ├── access.ts               # 权限配置
│   │   ├── app.ts                  # 应用配置
│   │   └── models/
│   │       └── global.ts           # 全局状态
│   └── .umirc.ts                   # 主应用配置
│
├── H02Front/                    # 人事子应用 (hr-app) - 仅总审核
│   ├── src/
│   │   └── pages/
│   │       ├── Student/            # 学生管理
│   │       │   ├── List/           # 学生列表
│   │       │   └── Edit/           # 学生编辑
│   │       └── Auditor/            # 审核员管理
│   │           ├── List/           # 审核员列表
│   │           └── Edit/           # 审核员编辑
│   └── .umirc.ts
│
├── H03Front/                    # 贷款应用 (loan-app) - qiankun 主应用
│   ├── src/
│   │   ├── components/
│   │   │   └── MicroAppContainer/  # qiankun 子应用容器
│   │   └── pages/
│   │       ├── Apply/              # 学生申请功能
│   │       │   ├── List/           # 申请列表
│   │       │   ├── Form/           # 申请表单
│   │       │   └── Detail/         # 申请详情
│   │       ├── Audit/              # 审核功能
│   │       │   ├── List/           # 待审核列表
│   │       │   └── Detail/         # 审核详情/操作
│   │       ├── FormConfig/         # 表单设置 (总审核)
│   │       └── FlowConfig/         # 流程设置 (嵌入 F04)
│   └── .umirc.ts
│
├── F04Front/                    # 流程管理平台 (flow-app) - qiankun 子应用
│   ├── src/
│   │   └── pages/
│   │       ├── FlowConfig/         # 流程设置 (被 H03 嵌入)
│   │       │   └── index.tsx       # 流程配置页
│   │       └── FlowAudit/          # 流程审核
│   │           ├── Todo/           # 代办
│   │           ├── Done/           # 已办
│   │           └── Copied/         # 已抄送
│   └── .umirc.ts
│
└── S01Back/                     # 后端服务
```

## 四、路由设计

### 4.1 主应用路由 (H01Front) - 端口 8000

```typescript
// H01Front/.umirc.ts
routes: [
  { path: "/", redirect: "/login" },
  { path: "/login", component: "./Login" },
  {
    path: "/app",
    component: "@/components/Layout",
    routes: [
      { path: "/app", redirect: "/app/notice" },
      // 信息通知模块
      { path: "/app/notice", component: "./Notice/List" },
      { path: "/app/notice/:id", component: "./Notice/Detail" },
    ],
  },
];
// 菜单中配置跳转链接：
// - 贷款模块 -> http://localhost:16003
// - 人事模块 -> http://localhost:16002
```

### 4.2 贷款应用路由 (H03Front) - 端口 16003 - qiankun 主应用

```typescript
// H03Front/.umirc.ts
import { defineConfig } from "@umijs/max";

export default defineConfig({
  qiankun: {
    master: {
      apps: [
        {
          name: "flow-app",
          entry: "//localhost:16004",
        },
      ],
    },
  },
  routes: [
    { path: "/", redirect: "/login" },
    { path: "/login", component: "./Login" },
    {
      path: "/loan",
      component: "@/components/Layout",
      routes: [
        { path: "/loan", redirect: "/loan/apply/list" },
        // 学生功能
        { path: "/loan/apply/list", component: "./Apply/List" },
        { path: "/loan/apply/form", component: "./Apply/Form" },
        { path: "/loan/apply/detail/:id", component: "./Apply/Detail" },
        // 审核功能
        { path: "/loan/audit/list", component: "./Audit/List" },
        { path: "/loan/audit/detail/:id", component: "./Audit/Detail" },
        // 表单设置 (总审核)
        { path: "/loan/form-config", component: "./FormConfig" },
        // 流程设置 (qiankun 嵌入 F04)
        { path: "/loan/flow-config/*", microApp: "flow-app" },
      ],
    },
  ],
});
```

### 4.3 人事应用路由 (H02Front) - 端口 16002

```typescript
// H02Front/.umirc.ts
routes: [
  { path: "/", redirect: "/login" },
  { path: "/login", component: "./Login" }, // 登录验证/跳转
  {
    path: "/hr",
    component: "@/components/Layout",
    routes: [
      { path: "/hr", redirect: "/hr/student/list" },
      // 学生管理
      { path: "/hr/student/list", component: "./Student/List" },
      { path: "/hr/student/edit/:id", component: "./Student/Edit" },
      // 审核员管理
      { path: "/hr/auditor/list", component: "./Auditor/List" },
      { path: "/hr/auditor/edit/:id", component: "./Auditor/Edit" },
    ],
  },
];
```

### 4.4 流程平台路由 (F04Front) - 端口 16004 - qiankun 子应用

```typescript
// F04Front/.umirc.ts
import { defineConfig } from "@umijs/max";

export default defineConfig({
  qiankun: {
    slave: {}, // 作为子应用
  },
  routes: [
    { path: "/", redirect: "/login" },
    { path: "/login", component: "./Login" },
    {
      path: "/flow",
      component: "@/components/Layout",
      routes: [
        { path: "/flow", redirect: "/flow/audit/todo" },
        // 流程设置 (被 H03 嵌入时访问)
        { path: "/flow/config", component: "./FlowConfig" },
        // 流程审核
        { path: "/flow/audit/todo", component: "./FlowAudit/Todo" },
        { path: "/flow/audit/done", component: "./FlowAudit/Done" },
        { path: "/flow/audit/copied", component: "./FlowAudit/Copied" },
      ],
    },
  ],
});
```

### 4.5 角色路由权限

| 路由                 | 学生 | 审核员 | 总审核 |
| -------------------- | :--: | :----: | :----: |
| /loan/apply/\*       |  ✓   |   ✗    |   ✗    |
| /loan/audit/\*       |  ✗   |   ✓    |   ✓    |
| /loan/flow-config/\* |  ✗   |   ✗    |   ✓    |
| /app/notice/\*       |  ✓   |   ✓    |   ✓    |
| /hr/\*               |  ✗   |   ✗    |   ✓    |
| /flow/audit/\*       |  ✗   |   ✓    |   ✓    |

## 五、权限设计

### 5.1 角色常量定义

```typescript
// src/constants/role.ts
export const ROLE = {
  STUDENT: "student", // 学生
  AUDITOR: "auditor", // 审核员
  SUPER_AUDITOR: "superAuditor", // 总审核
} as const;

export type RoleType = (typeof ROLE)[keyof typeof ROLE];
```

### 5.2 权限配置

```typescript
// src/access.ts
export default function access(initialState: { currentUser?: API.UserInfo }) {
  const { currentUser } = initialState || {};
  const role = currentUser?.role;

  return {
    // 学生权限
    canApplyLoan: role === ROLE.STUDENT,
    canViewApplyList: role === ROLE.STUDENT,

    // 审核员权限
    canAudit: role === ROLE.AUDITOR || role === ROLE.SUPER_AUDITOR,

    // 总审核权限
    canManageHR: role === ROLE.SUPER_AUDITOR,
    canConfigForm: role === ROLE.SUPER_AUDITOR,
    canManageStudent: role === ROLE.SUPER_AUDITOR,
    canManageAuditor: role === ROLE.SUPER_AUDITOR,

    // 通用权限
    canViewNotice: true,
  };
}
```

## 六、数据通信

### 6.1 Token 共享方案

各应用通过 `localStorage` 共享登录状态：

```typescript
// src/utils/auth.ts
const TOKEN_KEY = "loan_system_token";
const USER_KEY = "loan_system_user";

// 存储登录信息
export const setAuth = (token: string, user: API.UserInfo) => {
  localStorage.setItem(TOKEN_KEY, token);
  localStorage.setItem(USER_KEY, JSON.stringify(user));
};

// 获取 Token
export const getToken = () => localStorage.getItem(TOKEN_KEY);

// 获取用户信息
export const getUser = (): API.UserInfo | null => {
  const user = localStorage.getItem(USER_KEY);
  return user ? JSON.parse(user) : null;
};

// 清除登录信息
export const clearAuth = () => {
  localStorage.removeItem(TOKEN_KEY);
  localStorage.removeItem(USER_KEY);
};

// 检查是否登录
export const isLoggedIn = () => !!getToken();
```

### 6.2 应用跳转工具

```typescript
// src/utils/navigate.ts
const APP_URLS = {
  main: "http://localhost:8000", // H01Front
  hr: "http://localhost:16002", // H02Front
  loan: "http://localhost:16003", // H03Front
  flow: "http://localhost:16004", // F04Front
};

// 跳转到指定应用
export const navigateToApp = (app: keyof typeof APP_URLS, path = "/") => {
  window.location.href = `${APP_URLS[app]}${path}`;
};

// 跳转到登录页
export const navigateToLogin = () => {
  window.location.href = `${APP_URLS.main}/login`;
};
```

## 七、接口设计

### 7.1 贷款模块接口

| 接口                       | 方法 | 描述           | 角色          |
| -------------------------- | ---- | -------------- | ------------- |
| /api/loan/apply            | POST | 提交贷款申请   | 学生          |
| /api/loan/apply/list       | GET  | 获取申请列表   | 学生          |
| /api/loan/apply/:id        | GET  | 获取申请详情   | 全角色        |
| /api/loan/audit/list       | GET  | 获取待审核列表 | 审核员/总审核 |
| /api/loan/audit/:id/pass   | POST | 审核通过       | 审核员/总审核 |
| /api/loan/audit/:id/reject | POST | 审核驳回       | 审核员/总审核 |
| /api/loan/form/config      | GET  | 获取表单配置   | 总审核        |
| /api/loan/form/config      | PUT  | 更新表单配置   | 总审核        |

### 7.2 人事模块接口

| 接口                 | 方法   | 描述       | 角色   |
| -------------------- | ------ | ---------- | ------ |
| /api/hr/student/list | GET    | 学生列表   | 总审核 |
| /api/hr/student/:id  | GET    | 学生详情   | 总审核 |
| /api/hr/student/:id  | PUT    | 更新学生   | 总审核 |
| /api/hr/auditor/list | GET    | 审核员列表 | 总审核 |
| /api/hr/auditor/:id  | GET    | 审核员详情 | 总审核 |
| /api/hr/auditor      | POST   | 新增审核员 | 总审核 |
| /api/hr/auditor/:id  | PUT    | 更新审核员 | 总审核 |
| /api/hr/auditor/:id  | DELETE | 删除审核员 | 总审核 |

### 7.3 通知模块接口

| 接口                 | 方法 | 描述     | 角色   |
| -------------------- | ---- | -------- | ------ |
| /api/notice/list     | GET  | 通知列表 | 全角色 |
| /api/notice/:id/read | POST | 标记已读 | 全角色 |

### 7.4 流程模块接口 (F04)

| 接口                        | 方法 | 描述         | 角色          |
| --------------------------- | ---- | ------------ | ------------- |
| /api/flow/config            | GET  | 获取流程配置 | 总审核        |
| /api/flow/config            | PUT  | 更新流程配置 | 总审核        |
| /api/flow/audit/todo        | GET  | 代办列表     | 审核员/总审核 |
| /api/flow/audit/done        | GET  | 已办列表     | 审核员/总审核 |
| /api/flow/audit/copied      | GET  | 已抄送列表   | 审核员/总审核 |
| /api/flow/audit/:id/approve | POST | 审批通过     | 审核员/总审核 |
| /api/flow/audit/:id/reject  | POST | 审批驳回     | 审核员/总审核 |

## 八、开发计划

### 阶段一：基础架构搭建 (2 周)

- [ ] H01Front 主应用搭建
- [ ] H02Front 人事应用搭建
- [ ] H03Front 贷款应用搭建 (qiankun 主应用)
- [ ] F04Front 流程平台搭建 (qiankun 子应用)
- [ ] Token 共享机制
- [ ] 权限框架

### 阶段二：贷款模块开发 - H03Front (3 周)

- [ ] 学生申请功能
- [ ] 审核员审核功能
- [ ] 总审核审批功能
- [ ] 表单设置功能
- [ ] qiankun 嵌入 F04 流程设置

### 阶段三：流程平台开发 - F04Front (2 周)

- [ ] 流程设置页面
- [ ] 代办列表
- [ ] 已办列表
- [ ] 已抄送列表

### 阶段四：人事模块开发 - H02Front (1.5 周)

- [ ] 学生管理
- [ ] 审核员管理

### 阶段五：通知模块开发 - H01Front (1 周)

- [ ] 通知列表
- [ ] 消息推送

### 阶段六：联调测试 (2 周)

- [ ] 接口联调
- [ ] 权限测试
- [ ] qiankun 嵌入测试
- [ ] 性能优化

## 九、注意事项

1. **Token 同源**：各应用部署在同一域名下，确保 localStorage 共享
2. **登录跳转**：子应用检测未登录时跳转到主应用登录页
3. **菜单一致**：各应用使用统一的导航菜单组件，保持 UI 一致性
4. **跨域问题**：开发环境配置 CORS，生产环境使用反向代理统一域名
5. **qiankun 配置**：F04 作为子应用需配置 `slave`，H03 作为主应用需配置 `master`
6. **样式隔离**：F04 嵌入 H03 时使用 CSS Modules 避免样式冲突

---

**请确认此技术方案，确认后我将开始实现。**

微前端贷款审批系统流程介绍
整体流程图
┌─────────────────────────────────────────────────────────────────────────┐
│ 配置阶段 (总审核员) │
├─────────────────────────────────────────────────────────────────────────┤
│ 1. 流程设置 2. 表单设置 │
│ (H03 嵌入 F04) (H03Front) │
│ 配置审批节点和审核员 配置申请表单字段 │
└─────────────────────────────────────────────────────────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 审批发布阶段 (总审核员) │
├─────────────────────────────────────────────────────────────────────────┤
│ 3. 流程审核 - F04Front │
│ 在"代办"中审核通过配置的流程，使其生效 │
└─────────────────────────────────────────────────────────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 申请阶段 (学生) │
├─────────────────────────────────────────────────────────────────────────┤
│ 4. 申请列表 → 申请表单 │
│ (H03Front) │
│ 查看可申请的贷款类型，填写并提交申请表单 │
└─────────────────────────────────────────────────────────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 审核阶段 (审核员) │
├─────────────────────────────────────────────────────────────────────────┤
│ 5. 流程分发 │
│ 系统根据流程配置，将申请分发给对应审核员 │
│ │
│ 6. 审核操作 (F04Front 代办) │
│ 审核员查看申请 → 通过/驳回 │
└─────────────────────────────────────────────────────────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────────────────┐
│ 最终审批阶段 (总审核员) │
├─────────────────────────────────────────────────────────────────────────┤
│ 7. 总审核查看 │
│ (F04Front 代办/已抄送) │
│ 查看审核员的审批结果，进行最终审批或归档 │
└─────────────────────────────────────────────────────────────────────────┘
各阶段详细说明
阶段一：配置阶段 (总审核员)
步骤 操作位置 功能说明

1. 流程设置 H03Front → /loan/flow-config/\* (嵌入 F04) 配置审批流程节点，设置每个节点的审核员
2. 表单设置 H03Front → /loan/form-config 配置贷款申请表单的字段、校验规则等
   阶段二：审批发布 (总审核员)
   步骤 操作位置 功能说明
3. 流程审核 F04Front → /flow/audit/todo 审核通过配置的流程，使其对学生可见可申请
   阶段三：申请阶段 (学生)
   步骤 操作位置 功能说明
4. 填写表单 H03Front → /loan/apply/form 根据已发布的表单配置填写申请信息并提交
   阶段四：审核阶段 (审核员)
   步骤 操作位置 功能说明
5. 接收分发 系统自动 根据流程配置将申请分发给对应审核员
6. 审核操作 F04Front → /flow/audit/todo 审核员在代办中查看并通过/驳回申请
   阶段五：最终审批 (总审核员)
   步骤 操作位置 功能说明
7. 查看结果 F04Front → /flow/audit/todo 或 /flow/audit/copied 查看审核员的处理结果，进行最终审批或归档
   系统交互示意
   总审核员 审核员 学生
   │ │ │
   │ 1. 流程设置 (H03→F04) │ │
   │ 2. 表单设置 (H03) │ │
   │ 3. 审核通过流程 (F04) │ │
   │ │ │
   │ │ 4. 填写表单 (H03)
   │ │ │
   │ │ ←───── 5. 系统分发 ───── │
   │ │ │
   │ │ 6. 通过/驳回 (F04) │
   │ │ │
   │ ←──── 7. 抄送/待办 ──────│ │
   │ │ │
   │ 8. 最终审批/归档 │ │
   ▼ ▼ ▼
   这个流程设计确保了：

配置先行：总审核员先完成流程和表单的配置
权限分明：各角色只能操作自己权限范围内的功能
流程可控：通过流程设置可灵活配置审批节点和审核员
追溯完整：通过已办、已抄送可查看完整审批历史
